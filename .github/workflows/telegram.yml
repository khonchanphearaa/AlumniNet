name: Telegram Notify

on:
  push:
  pull_request:
  create:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram message
        run: |
          # 1. Setup Variables
          REPO_NAME="${{ github.repository }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          ACTOR="${{ github.actor }}"
          EVENT_NAME="${{ github.event_name }}"
          
          # Clean Branch Name
          BRANCH=$(echo "${{ github.ref }}" | sed -e 's|refs/heads/||' -e 's|refs/tags/||')

          # 2. Advanced Logic for Events
          if [ "$EVENT_NAME" = "push" ]; then
            # Get first 50 chars of commit message and the link
            COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n 1 | cut -c1-50)
            COMMIT_URL="${{ github.event.head_commit.url }}"
            
            if [[ "$COMMIT_MSG" == *"Merge pull request"* ]]; then
               ACTION_LINE="ğŸ“¥ <b>Action:</b> <a href='$COMMIT_URL'>Merge into $BRANCH</a>"
            else
               ACTION_LINE="ğŸ“ <b>Msg:</b> <a href='$COMMIT_URL'>$COMMIT_MSG</a>"
            fi

            MESSAGE="âœ¨ <b>New Push Activity</b> âœ¨%0A%0A<b>ğŸ“‚ Repo:</b> <a href='$REPO_URL'>$REPO_NAME</a>%0A<b>ğŸ‘¤ By:</b> $ACTOR%0A<b>ğŸŒ¿ Branch:</b> <code>$BRANCH</code>%0A$ACTION_LINE"

          elif [ "$EVENT_NAME" = "pull_request" ]; then
            ACTION="${{ github.event.action }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_URL="${{ github.event.pull_request.html_url }}"
            PR_FLOW="<code>${{ github.event.pull_request.head.ref }}</code> â” <code>${{ github.event.pull_request.base.ref }}</code>"
            
            # Status Emojis
            [[ "$ACTION" == "opened" ]] && STATE="ğŸŸ¢" || STATE="ğŸ”µ"
            
            MESSAGE="ğŸ¤ <b>PR Notification</b> ğŸ¤%0A%0A<b>$STATE Status:</b> $ACTION%0A<b>ğŸ“‚ Repo:</b> <a href='$REPO_URL'>$REPO_NAME</a>%0A<b>ğŸ”¢ PR:</b> <a href='$PR_URL'>#$PR_NUM</a>%0A<b>ğŸ‘¤ Actor:</b> $ACTOR%0A<b>ğŸ”ƒ Flow:</b> $PR_FLOW%0A<b>ğŸ’­ Title:</b> $PR_TITLE"

          elif [ "$EVENT_NAME" = "create" ]; then
            TYPE="${{ github.event.ref_type }}"
            REF_NAME="${{ github.event.ref }}"
            MESSAGE="ğŸŒ± <b>New $TYPE Created</b> ğŸŒ±%0A%0A<b>ğŸ“‚ Repo:</b> <a href='$REPO_URL'>$REPO_NAME</a>%0A<b>ğŸ‘¤ By:</b> $ACTOR%0A<b>ğŸ“ Name:</b> <code>$REF_NAME</code>"
          fi

          # 3. Final API Call
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d parse_mode="HTML" \
            -d disable_web_page_preview="true" \
            -d text="$MESSAGE"
